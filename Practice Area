/**
 * @NApiVersion 2.0
 * @NScriptType MapReduceScript
 * @NModuleScope SameAccount
 */
define([
    'N/search', 'N/record', 'N/runtime', 'N/xml', 'N/file', 'N/render',
    'N/url', 'N/encode', 'N/email', 'N/format', 'N/task'
], function (search, record, runtime, xmlMod, file, render, url, encode, email, format, task) {

    var defaultEmpID = 215516;
    var folderID = 148222;
    var templateDefault = 25;
    var brazilTemplate = 26;
    var logoDefault = '3662874';
    var logoBrazil = '3662875';

    var statementScript = runtime.getCurrentScript();
    var FILE_CONST = {
        SEARCH_INPUT: statementScript.getParameter({ name: 'custscript_weeklyst_searchinput' }),
        SEARCH_TRANSACTIONS: statementScript.getParameter({ name: 'custscript_weeklyst_searchtransactions' }),
        ARRIVAL_DATE: statementScript.getParameter({ name: 'custscript_weeklyst_searcharrivaldate' }) || '',
        RESUME_FROM_CUSTOMER: statementScript.getParameter({ name: 'custscript_resume_from_customer' }) || ''
    };

    /* --------------------------- GET INPUT --------------------------- */
    function getInputData() {
        log.audit("begin getInputData", new Date());
        var statementSearch = search.load(FILE_CONST.SEARCH_INPUT);
        var defValue = statementScript.getParameter({ name: 'custscript_customerfilter' });

        if (defValue) {
            var paramFilter = search.createFilter({
                name: 'internalid',
                join: 'customer',
                operator: 'anyof',
                values: defValue
            });
            statementSearch.filters.push(paramFilter);
        }

        if (FILE_CONST.RESUME_FROM_CUSTOMER) {
            var resumeFilter = search.createFilter({
                name: 'internalidnumber',
                join: 'customer',
                operator: 'greaterthan',
                values: FILE_CONST.RESUME_FROM_CUSTOMER
            });
            statementSearch.filters.push(resumeFilter);
        }

        return statementSearch;
    }

    /* --------------------------- REDUCE --------------------------- */
    function reduce(context) {
        var startTime = new Date().getTime();
        var thresholdUsage = 350;
        var thresholdTime = 50 * 60 * 1000; // 50 minutes

        for (var i in context.values) {
            var remaining = runtime.getCurrentScript().getRemainingUsage();
            var elapsed = new Date().getTime() - startTime;

            if (remaining < thresholdUsage || elapsed > thresholdTime) {
                log.audit('Rescheduling triggered', 'Remaining=' + remaining + ', Elapsed(ms)=' + elapsed);
                // pass the current reduce key so next run can resume after it if you use resume filter
                rescheduleMapReduce(context.key);
                return;
            }

            try {
                var tranData = JSON.parse(context.values[i]).values;
                var custId = tranData["GROUP(entity)"].value;
                var statementDate = getStatementDate();
                log.audit('Processing customer', custId);

                var customerRecord = record.load({ type: 'customer', id: custId });
                var cusObj = buildCustomerObject(customerRecord, custId);

                var attachmentArr = [];
                var currencyList = [1, 2, 4];
                for (var c = 0; c < currencyList.length; c++) {
                    var currency = currencyList[c];
                    var resultsAmount = getTransactions(custId, currency);
                    if (!resultsAmount || !resultsAmount.length) continue;

                    var netAmount = getBalance(custId, resultsAmount, currency);
                    if (!netAmount || parseFloat(netAmount) <= 0) continue;

                    var files = createPDF(cusObj, netAmount, resultsAmount, statementDate, currency);
                    if (files) {
                        attachmentArr.push(files.pdf);
                        attachmentArr.push(files.excel);
                    }
                }

                if (attachmentArr.length) {
                    sendEmail(cusObj, statementDate, attachmentArr);
                    record.submitFields({
                        type: 'customer',
                        id: custId,
                        values: { custentity_upaya_last_statement_date: statementDate }
                    });
                }

                log.audit('Customer done', custId);
            } catch (e) {
                log.error('Reduce Error', e);
            }
        }
    }

    /* --------------------------- SUMMARIZE --------------------------- */
    function summarize(summary) {
        log.audit('Summary complete', JSON.stringify(summary));
        if (summary.inputSummary && summary.inputSummary.error) {
            log.error('Input Error', summary.inputSummary.error);
        }

        if (summary.mapSummary && summary.mapSummary.errors) {
            summary.mapSummary.errors.iterator().each(function (key, error) {
                log.error('Map Error for ' + key, error);
                return true;
            });
        }

        if (summary.reduceSummary && summary.reduceSummary.errors) {
            summary.reduceSummary.errors.iterator().each(function (key, error) {
                log.error('Reduce Error for ' + key, error);
                return true;
            });
        }
    }

    /* --------------------------- RESCHEDULE --------------------------- */
    function rescheduleMapReduce(lastCustomerId) {
        try {
            var curScript = runtime.getCurrentScript();
            var mrTask = task.create({ taskType: task.TaskType.MAP_REDUCE });
            mrTask.scriptId = curScript.id;
            mrTask.deploymentId = curScript.deploymentId;
            mrTask.params = { custscript_resume_from_customer: lastCustomerId || '' };
            var taskId = mrTask.submit();
            log.audit('Rescheduled MR', 'taskId=' + taskId + ' from customer=' + lastCustomerId);
        } catch (e) {
            log.error('Reschedule failed', e);
        }
    }

    /* --------------------------- CUSTOMER BUILD --------------------------- */
    function buildCustomerObject(customerRecord, custId) {
        var obj = {};
        obj.cname = custId;
        obj.customerName = customerRecord.getValue('isperson') ? customerRecord.getValue('altname') : customerRecord.getValue('companyname');
        obj.arSpecialist = customerRecord.getValue('custentity_bonotel_ar_specialist');
        obj.customerEmail = customerRecord.getValue('custentity_2663_email_address_notif');
        obj.customerTemplate = customerRecord.getValue('custentity_custom_email_template');

        var addrCount = customerRecord.getLineCount({ sublistId: 'addressbook' });
        for (var a = 0; a < addrCount; a++) {
            var isDefaultBilling = customerRecord.getSublistValue({
                sublistId: 'addressbook',
                fieldId: 'defaultbilling',
                line: a
            });

            if (isDefaultBilling) {
                var addressSubrecord = customerRecord.getSublistSubrecord({
                    sublistId: 'addressbook',
                    fieldId: 'addressbookaddress',
                    line: a
                });

                if (addressSubrecord) {
                    obj.customeraddress = addressSubrecord.getValue({ fieldId: 'addr1' }) || '';
                    obj.city = addressSubrecord.getValue({ fieldId: 'city' }) || '';
                    obj.state = addressSubrecord.getValue({ fieldId: 'state' }) || '';
                    obj.zip = addressSubrecord.getValue({ fieldId: 'zip' }) || '';
                    obj.country = addressSubrecord.getValue({ fieldId: 'country' }) || '';
                }
                break;
            }
        }

        return obj;
    }

    /* --------------------------- HELPERS --------------------------- */
    function isEmpty(value) {
        if (value === null || value === undefined) return true;
        if (typeof value === 'string' && value.trim() === '') return true;
        if (Array.isArray(value) && value.length === 0) return true;
        return false;
    }

    function getnumber(id) {
        var ret = parseFloat(id);
        if (isNaN(ret)) ret = 0;
        return ret;
    }

    function getTimestamp() {
        var now = new Date();
        var y = "" + now.getFullYear();
        var m = "" + (now.getMonth() + 1); if (m.length == 1) m = "0" + m;
        var d = "" + now.getDate(); if (d.length == 1) d = "0" + d;
        var hh = "" + now.getHours(); if (hh.length == 1) hh = "0" + hh;
        var mm = "" + now.getMinutes(); if (mm.length == 1) mm = "0" + mm;
        var ss = "" + now.getSeconds(); if (ss.length == 1) ss = "0" + ss;
        return y + m + d + hh + mm + ss;
    }

    function formatMoney(value) {
        if (value === null || value === undefined || value === '') return '0.00';
        var num = parseFloat(value);
        if (isNaN(num)) num = 0;
        // Use toLocaleString for thousands separator and 2 decimal places
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatAmount(nStr) {
        nStr = (nStr === null || nStr === undefined) ? '0' : String(nStr);
        var x = nStr.split('.');
        var x1 = x[0];
        var x2 = x.length > 1 ? '.' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }

    function formatString(str) {
        if (!str) return '';
        str = str.replace(/CustInvc/g, 'Invoice');
        str = str.replace(/SalesOrd/g, 'Sales Order');
        str = str.replace(/CustDep/g, 'Customer Deposit');
        str = str.replace(/CustCred/g, 'Credit Memo');
        return str;
    }

    function runSearchPaged(recType, searchId, filters) {
        if (!recType && !searchId) return [];

        var searchRec;
        if (searchId) {
            searchRec = search.load({ id: searchId });
            if (filters && filters.length) {
                for (var f = 0; f < filters.length; f++) {
                    searchRec.filters.push(filters[f]);
                }
            }
        } else {
            searchRec = search.create({ type: recType, filters: filters });
        }

        var allResults = [];
        try {
            var paged = searchRec.runPaged({ pageSize: 1000 });
            var pageRanges = paged.pageRanges;
            for (var p = 0; p < pageRanges.length; p++) {
                var page = paged.fetch({ index: pageRanges[p].index });
                var pageData = page.data;
                for (var r = 0; r < pageData.length; r++) {
                    allResults.push(pageData[r]);
                }
                var remaining = runtime.getCurrentScript().getRemainingUsage();
                if (remaining < 200) {
                    log.audit('runSearchPaged: low governance, stopping page fetch', 'remaining=' + remaining);
                    break;
                }
            }
        } catch (err) {
            log.error('runSearchPaged error', err);
            throw err;
        }
        return allResults;
    }

    function loadCurrency(currencyId) {
        var rec = record.load({ type: 'currency', id: currencyId });
        var obj = {};
        obj.symbol = rec.getValue({ fieldId: 'displaysymbol' }) || '$';
        obj.code = rec.getValue({ fieldId: 'symbol' }) || '';
        return obj;
    }

    /* --------------------------- TRANSACTION HELPERS --------------------------- */
    function getTransactions(cname, currency) {
        try {
            var startdate = new Date(2016, 0, 1);
            var enddate = new Date();
            var middate = new Date((startdate.getTime() + enddate.getTime()) / 2);
            var midDateStr = String(middate.getMonth() + 1) + "/" + String(middate.getDate()) + "/" + String(middate.getFullYear());

            var custIdFilter = search.createFilter({ name: 'entity', operator: 'anyof', values: cname });
            var currencyFilter = search.createFilter({ name: 'currency', operator: 'anyof', values: currency });

            var resultsAmount = [];

            if (!isEmpty(FILE_CONST.ARRIVAL_DATE)) {
                var dateFilterArrival = search.createFilter({ name: 'custbody_arrival_date', operator: 'onorafter', values: FILE_CONST.ARRIVAL_DATE });
                var filtersArrival = [custIdFilter, dateFilterArrival, currencyFilter];
                resultsAmount = runSearchPaged('transaction', FILE_CONST.SEARCH_TRANSACTIONS, filtersArrival) || [];
            } else {
                var dateFilterBefore = search.createFilter({ name: 'custbody_arrival_date', operator: 'before', values: midDateStr });
                var dateFilterAfter = search.createFilter({ name: 'custbody_arrival_date', operator: 'onorafter', values: midDateStr });

                var filtersOlder = [custIdFilter, dateFilterBefore, currencyFilter];
                var filtersNewer = [custIdFilter, dateFilterAfter, currencyFilter];

                var resultsOlder = runSearchPaged('transaction', FILE_CONST.SEARCH_TRANSACTIONS, filtersOlder) || [];
                var resultsNewer = runSearchPaged('transaction', FILE_CONST.SEARCH_TRANSACTIONS, filtersNewer) || [];
                resultsAmount = resultsOlder.concat(resultsNewer);
            }
            return resultsAmount;
        } catch (err) {
            if (err && err.name === 'SSS_SEARCH_TIMEOUT') {
                log.error('getTransactions search timeout for customer ' + cname, err);
                try { rescheduleMapReduce(cname); } catch (e) { log.error('Reschedule after timeout failed', e); }
            }
            throw err;
        }
    }

    function getBalance(cname, resultsAmount, currency) {
        log.audit('getBalance START', 'cname=' + cname + ' | currency=' + currency + ' | resultsAmount.length=' + (resultsAmount ? resultsAmount.length : 0));
        var clientBalance = 0;
        var typeCol = search.createColumn({ name: 'type' });
        var custDueDateCol = search.createColumn({ name: 'custbody_due_date' });
        var dueDateCol = search.createColumn({ name: 'duedate' });

        for (var aa = 0; resultsAmount != null && aa < resultsAmount.length; aa++) {
            var resultsGetAmount = resultsAmount[aa];
            var _type = resultsGetAmount.getValue(typeCol);

            var depamt = parseFloat(resultsGetAmount.getValue('custbody_total_earmarks')) || 0;
            var amt = (currency == 1) ? parseFloat(resultsGetAmount.getValue('amount')) || 0 : parseFloat(resultsGetAmount.getValue('fxamount')) || 0;

            var remaining = getnumber(amt) - getnumber(depamt);
            if (_type === 'SalesOrd') {
                remaining = getnumber(amt) - getnumber(depamt);
            } else {
                remaining = (currency == 1) ? parseFloat(resultsGetAmount.getValue('amountremaining')) || 0 : parseFloat(resultsGetAmount.getValue('fxamountremaining')) || 0;
            }

            var dueDate = '';
            if (!isEmpty(resultsGetAmount.getValue(custDueDateCol))) {
                dueDate = resultsGetAmount.getValue(custDueDateCol);
            } else {
                dueDate = resultsGetAmount.getValue(dueDateCol);
            }

            if (!dueDate) {
                log.audit("setting check due date to true and breaking", resultsGetAmount.getValue('internalid'));
                return; // follow original behavior: return undefined to indicate issue
            }

            if (remaining > 0) {
                clientBalance += remaining;
            }
        }

        var amid1 = clientBalance.toFixed(2);
        var netAmount = formatAmount(amid1);
        log.audit('getBalance of ', cname + ':' + netAmount);
        if (netAmount == '0.00') {
            log.audit('getBalance is zero!!!', 'Skip this customer ' + cname);
            return '';
        }
        return netAmount;
    }

    /* --------------------------- PDF / EXCEL / EMAIL --------------------------- */
    function createPDF(cusObj, netAmount, resultsAmount, statementDate, currency) {
        log.audit('createPDF START', 'netAmount=' + netAmount + ' for currency=' + currency);
        var currencyObj = loadCurrency(currency);
        var currencySymbol = currencyObj.symbol;
        var currencyCode = currencyObj.code;

        var cname = cusObj.cname;
        var customerName = cusObj.customerName;
        var customerTemplate = cusObj.customerTemplate;
        var customeraddress = cusObj.customeraddress;
        var city = cusObj.city;
        var state = cusObj.state;
        var zip = cusObj.zip;
        var country = cusObj.country;
        log.audit('createPDF', JSON.stringify(cusObj));

        var today = getTimestamp();

        // header image table
        var strNamePic = "<table>";
        strNamePic += "<tr><td>";
        strNamePic += "<img src=\"";
        try {
            if (customerTemplate == brazilTemplate) {
                var img = file.load({ id: logoBrazil });
                var imgUrl = img.url;
                var path = xmlMod.escape({ xmlText: imgUrl });
            } else {
                var img = file.load({ id: logoDefault });
                var imgUrl = img.url;
                var path = xmlMod.escape({ xmlText: imgUrl });
            }
            strNamePic += path;
        } catch (e) {
            log.error('logo load failed', e);
        }
        strNamePic += "\"></img>";
        strNamePic += "</td></tr></table>";

        // customer info table
        var strName = "<table>";
        strName += "<tr><td></td><td> </td><td> </td></tr>";
        strName += "<tr><td></td><td>Customer:</td><td>" + xmlMod.escape({ xmlText: customerName }) + "</td></tr>";
        strName += "<tr><td></td><td>Address:</td><td>" + xmlMod.escape({ xmlText: customeraddress }) + "</td></tr>";
        strName += "<tr><td></td><td>City:</td><td>" + xmlMod.escape({ xmlText: city }) + "</td></tr>";
        strName += "<tr><td></td><td>State:</td><td>" + xmlMod.escape({ xmlText: state }) + "</td></tr>";
        strName += "<tr><td></td><td>Country:</td><td>" + xmlMod.escape({ xmlText: country }) + "</td></tr>";
        strName += "<tr><td></td><td>ZipCode:</td><td>" + xmlMod.escape({ xmlText: zip }) + "</td></tr>";
        strName += "<tr><td></td><td>Statement Date:</td><td>" + statementDate + "</td></tr>";
        strName += "<tr><td></td><td>Amount Due:</td><td>" + currencySymbol + ' ' + netAmount + "</td></tr>";
        strName += "</table>";

        var strName2 = '<table width="100%" border="1" style="border-color: #808080; border-collapse:collapse;">';
        strName2 += '<thead>';
        strName2 += '<tr style="font-weight:bold; height:10px; font-size: 8px; background-color:Gray; color: #FFFFFF;" align="left">';
        strName2 += '<th>Hotel Name</th><th>Account #</th><th>Reservation #</th><th>Your Ref. #</th><th>Arrival</th><th>Departure</th><th>Guest(s) Name</th><th>Due Date</th><th>Reservation Value</th><th>Amount Due</th>';
        strName2 += '</tr></thead>';

        // excel xml header
        var xmlString = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
        xmlString += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">';
        xmlString += '<Worksheet ss:Name="Sheet1"><Table>';
        xmlString += '<Row><Cell><Data ss:Type="String">Name</Data></Cell><Cell><Data ss:Type="String">' + customerName + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Address</Data></Cell><Cell><Data ss:Type="String">' + customeraddress + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">City</Data></Cell><Cell><Data ss:Type="String">' + city + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">State</Data></Cell><Cell><Data ss:Type="String">' + state + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Country</Data></Cell><Cell><Data ss:Type="String">' + country + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">ZipCode</Data></Cell><Cell><Data ss:Type="String">' + zip + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String"> </Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Statement Date:</Data></Cell><Cell><Data ss:Type="String">' + statementDate + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Amount Due</Data></Cell><Cell><Data ss:Type="String">' + currencySymbol + '  ' + netAmount + '</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String"> </Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Hotel Name</Data></Cell><Cell><Data ss:Type="String">Account #</Data></Cell><Cell><Data ss:Type="String">Invoice #</Data></Cell><Cell><Data ss:Type="String">Reservation #</Data></Cell><Cell><Data ss:Type="String">Your Ref. #</Data></Cell><Cell><Data ss:Type="String">Arrival</Data></Cell><Cell><Data ss:Type="String">Departure</Data></Cell><Cell><Data ss:Type="String">Guest(s) Name</Data></Cell><Cell><Data ss:Type="String">Due Date</Data></Cell><Cell><Data ss:Type="String">Reservation Value</Data></Cell><Cell><Data ss:Type="String">Amount Due</Data></Cell></Row>';

        var agingCurrent = 0.00;
        var agingStage1 = 0.00;
        var agingStage2 = 0.00;
        var agingStage3 = 0.00;
        var agingStage4 = 0.00;
        var agingStage5 = 0.00;

        var resultsFinal = resultsAmount;
        log.audit('# of statement lines', 'resultsFinal=' + (resultsFinal ? resultsFinal.length : 0));

        for (var y = 0; resultsFinal != null && y < resultsFinal.length; y++) {
            var resultsget = resultsFinal[y];

            // determine amount
            var amount;
            if (currency != 1) {
                amount = resultsget.getValue({ name: 'fxamount' }) || resultsget.getValue('amount') || 0;
            } else {
                amount = resultsget.getValue({ name: 'amount' }) || 0;
            }

            var booknum = resultsget.getValue({ name: 'name', join: 'CUSTBODY_TRANSACTION_RESERVATION_LINK' }) || resultsget.getValue({ name: 'custbody_booking_number' });
            var guest = resultsget.getValue({ name: "custbody_guest_names" });
            var arrival = resultsget.getValue({ name: "custbody_arrival_date" });
            var departure = resultsget.getValue({ name: "custbody_departure_date" });
            var provider = resultsget.getText({ name: "custbody_provider_id" });
            var account = resultsget.getValue({ name: "altname", join: "CUSTBODY_CUSTOMER_ACCOUNT" });
            var rez = resultsget.getValue({ name: "name", join: "CUSTBODY_TRANSACTION_RESERVATION_LINK" });
            if (!rez || rez == "- None -") rez = resultsget.getValue({ name: "custbody_booking_number" });
            booknum = rez;
            var tranId = resultsget.getValue({ name: "tranid" });
            if (currency != 1) {
                amount = resultsget.getValue({ name: "fxamount" });
            } else {
                amount = resultsget.getValue({ name: "amount" });
            }

            guest = resultsget.getValue({ name: "custbody_guest_names" });
            var depositamount = resultsget.getValue({ name: "custbody_total_earmarks" }) || 0;
            var amountRem = 0.00;
            var type = resultsget.getValue({ name: "type" });
            var dueDate = '';

            if (type == 'SalesOrd') {
                tranId = '';
                dueDate = resultsget.getValue({ name: "custbody_due_date" }) || '';
                amountRem = getnumber(amount) - getnumber(depositamount);
            } else {
                dueDate = resultsget.getValue({ name: "custbody_due_date" }) || resultsget.getValue({ name: "duedate" }) || '';
                if (currency != 1) {
                    amountRem = getnumber(resultsget.getValue({ name: "fxamountremaining" }));
                } else {
                    amountRem = getnumber(resultsget.getValue({ name: "amountremaining" }));
                }
            }

            var refNo = resultsget.getValue({ name: "custbody_tour_operator_order_number" });

            if (amountRem > 0) {
                var agingdays = 0;
                if (dueDate) agingdays = days_between(statementDate, dueDate);
                if (agingdays == 0 || agingdays < 0) { agingCurrent += getnumber(amountRem); }
                else if (agingdays <= 30 && agingdays >= 1) { agingStage1 += getnumber(amountRem); }
                else if (agingdays <= 60 && agingdays >= 31) { agingStage2 += getnumber(amountRem); }
                else if (agingdays <= 90 && agingdays >= 61) { agingStage3 += getnumber(amountRem); }
                else if (agingdays >= 90) { agingStage4 += getnumber(amountRem); }
                agingStage5 += getnumber(amountRem);

                xmlString += '<Row><Cell><Data ss:Type="String">' + (provider || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (account || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (tranId || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (booknum || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (refNo || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (arrival || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (departure || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (guest || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (dueDate || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(amount) + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(amountRem) + '</Data></Cell>' +
                    '</Row>';

                strName2 += "<tr>";
                strName2 += '<td style="padding-left:5px;">' + xmlMod.escape({ xmlText: provider || '' }) + '</td>';
                strName2 += '<td style="padding-left:5px;">' + xmlMod.escape({ xmlText: account || '' }) + '</td>';
                strName2 += '<td style="padding-left:5px;">' + xmlMod.escape({ xmlText: booknum || '' }) + '</td>';
                strName2 += '<td style="padding-left:5px;">' + xmlMod.escape({ xmlText: refNo || '' }) + '</td>';
                strName2 += '<td>' + (arrival || '') + '</td>';
                strName2 += '<td>' + (departure || '') + '</td>';
                strName2 += '<td>' + xmlMod.escape({ xmlText: guest || '' }) + '</td>';
                strName2 += '<td>' + (dueDate || '') + '</td>';
                strName2 += '<td style="text-align:right;">' + currencySymbol + '  ' + formatMoney(amount) + '</td>';
                strName2 += '<td style="text-align:right;">' + currencySymbol + '  ' + formatMoney(amountRem) + '</td>';
                strName2 += "</tr><tr></tr>";
            }
        }

        xmlString += '<Row><Cell><Data ss:Type="String"></Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Aging</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Current</Data></Cell><Cell><Data ss:Type="String">1-30 Days</Data></Cell><Cell><Data ss:Type="String">31-60 Days</Data></Cell><Cell><Data ss:Type="String">61-90 Days</Data></Cell><Cell><Data ss:Type="String">Over 90 Days</Data></Cell><Cell><Data ss:Type="String">Total</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(agingCurrent.toFixed(2)) + '</Data></Cell><Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(agingStage1.toFixed(2)) + '</Data></Cell><Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(agingStage2.toFixed(2)) + '</Data></Cell><Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(agingStage3.toFixed(2)) + '</Data></Cell><Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(agingStage4.toFixed(2)) + '</Data></Cell><Cell><Data ss:Type="String">' + currencySymbol + '  ' + formatMoney(agingStage5.toFixed(2)) + '</Data></Cell></Row>';
        xmlString += '</Table></Worksheet></Workbook>';

        // Create XLS file
        var strXmlEncoded = encode.convert({ string: xmlString, inputEncoding: encode.Encoding.UTF_8, outputEncoding: encode.Encoding.BASE_64 });
        var objXlsFile = file.create({
            name: (currency == 2 ? 'ExcelGBP_' : 'ExcelUSD_') + customerName + '_' + today + '.xls',
            fileType: file.Type.EXCEL,
            contents: strXmlEncoded
        });
        objXlsFile.folder = folderID;
        var fileID = objXlsFile.save();

        strName2 += '</table>';
        var strNameSpace = '<table></table>';
        var strName3 = '<table></table>'; // if you need rich aging HTML put it here

        var payLinkURL = getPayLinkURL(cname);
        var strPayLink = '<table width="100%" style="margin-top:30px"><tr style="font-size:12px;color:blue"><td align="right">';
        if (!isEmpty(payLinkURL)) {
            var payLinkPath = xmlMod.escape({ xmlText: payLinkURL });
            strPayLink += '<a href="' + payLinkPath + '">Click Here to Pay</a>';
        }
        strPayLink += '</td></tr></table>';

        var xml = "<?xml version=\"1.0\"?>\n<!DOCTYPE pdf PUBLIC \"-//big.faceless.org//report\" \"report-1.1.dtd\">\n";
        xml += "<pdf>\n<head><macrolist><macro id=\"myheader\"><p align=\"left\">" + strNamePic + "</p></macro><macro id=\"myfooter\"><p align=\"right\">Page <pagenumber/> of <totalpages/></p></macro></macrolist></head>";
        xml += "<body font-size=\"7\" header=\"myheader\" header-height=\"20mm\" footer=\"myfooter\" footer-height=\"20mm\">";
        xml += strName + strName2 + strNameSpace + strName3 + strPayLink;
        xml += "</body></pdf>";

        var file2 = render.xmlToPdf({ xmlString: xml });
        file2.folder = folderID;
        file2.name = 'PDF' + currencyCode + '_' + customerName + '_' + today + '.pdf';
        var fileID2 = file2.save();

        // Attach files to customer
        try {
            record.attach({ record: { type: 'file', id: fileID2 }, to: { type: 'customer', id: cname } });
        } catch (e) { log.error('attach pdf failed', e); }
        try {
            record.attach({ record: { type: 'file', id: fileID }, to: { type: 'customer', id: cname } });
        } catch (e) { log.error('attach excel failed', e); }

        var createdFiles = { pdf: fileID2, excel: fileID };
        return createdFiles;
    } // end createPDF

    function sendEmail(cusObj, statementDate, attachmentArr) {
        var cname = cusObj.cname;
        var customerName = cusObj.customerName;
        var customerEmail = cusObj.customerEmail;
        var customerTemplate = cusObj.customerTemplate;

        var emailTempId;
        if (customerTemplate == brazilTemplate) {
            emailTempId = brazilTemplate;
        } else {
            if (customerTemplate && customerTemplate.length > 0) emailTempId = parseInt(customerTemplate);
            else emailTempId = templateDefault;
        }

        var emailTemp = record.load({ type: 'emailtemplate', id: emailTempId });
        var emailBody = emailTemp.getValue('content');

        var custArray = [];
        if (!isEmpty(customerEmail)) {
            custArray = customerEmail.split(';').map(function (s) { return s.trim(); });
        }

        var fileLoadArr = [];
        for (var f = 0; f < attachmentArr.length; f++) {
            try {
                var fileload = file.load({ id: attachmentArr[f] });
                fileLoadArr.push(fileload);
            } catch (err) {
                log.error('file.load failed for id ' + attachmentArr[f], err);
            }
        }

        var emailSubject = customerName + ' Statements for ' + statementDate;
        email.send({
            author: defaultEmpID,
            recipients: custArray,
            subject: emailSubject,
            body: emailBody,
            attachments: fileLoadArr,
            relatedRecords: { entityId: cname }
        });

        log.audit('EMAIL SENT cname=' + cname, emailSubject);
        return true;
    }

    function getPayLinkURL(custId) {
        var payLinkURL = '';
        var salesorderSearchObj = search.create({
            type: 'salesorder',
            filters: [
                ['type', 'anyof', 'SalesOrd'],
                'AND',
                ['mainline', 'is', 'T'],
                'AND',
                ['status', 'anyof', 'SalesOrd:B'],
                'AND',
                ['custbody_mes_invl_end_customer_link', 'isnotempty', ''],
                'AND',
                ['customermain.internalidnumber', 'equalto', custId]
            ],
            columns: [
                search.createColumn({ name: 'trandate', sort: search.Sort.ASC }),
                search.createColumn({ name: 'tranid' }),
                search.createColumn({ name: 'custbody_mes_invl_end_customer_link' })
            ]
        });
        var searchResultCount = salesorderSearchObj.runPaged().count;
        if (searchResultCount > 0) {
            var searchResult = salesorderSearchObj.run().getRange({ start: 0, end: 1 });
            payLinkURL = searchResult[0].getValue({ name: 'custbody_mes_invl_end_customer_link' });
        }
        return payLinkURL;
    }

    function days_between(date1, date2) {
        var ONE_DAY = 1000 * 60 * 60 * 24;
        var date1_date, date2_date;
        if (typeof date1 == "string") date1_date = format.parse({ value: date1, type: format.Type.DATE }); else date1_date = date1;
        if (typeof date2 == "string") date2_date = format.parse({ value: date2, type: format.Type.DATE }); else date2_date = date2;
        var difference_ms = (date1_date.getTime() - date2_date.getTime());
        return Math.round(difference_ms / ONE_DAY);
    }

    function getStatementDate() {
        var now = new Date();
        var year = "" + now.getFullYear();
        var month = "" + (now.getMonth() + 1); if (month.length == 1) month = "0" + month;
        var day = "" + now.getDate(); if (day.length == 1) day = "0" + day;
        return month + '/' + day + '/' + year;
    }

    return {
        getInputData: getInputData,
        reduce: reduce,
        summarize: summarize
    };
});


