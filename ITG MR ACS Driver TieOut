/**
 * @NApiVersion 2.0
 * @NScriptType MapReduceScript
 * @NModuleScope Public
 */

define(['N/search', 'N/config', 'N/runtime', 'N/email', 'N/file'],
function (search, config, runtime, email, file) {

    var script = runtime.getCurrentScript();

    var PARAMS = {
        DRIVER_SEARCH: script.getParameter('custscript_acs_driver_search'),
        PDF_SEARCH: script.getParameter('custscript_acs_pdf_sec_summ_search'),
        COMM_SEARCH: script.getParameter('custscript_acs_supp_comm_summary_srch'),
        PERIOD: script.getParameter('custscript_tlg_mr_driver_prd'),
        SUB: script.getParameter('custscript_tlg_mr_driver_subs'),
        FOLDER: script.getParameter('custscript_itg_folder_id')
    };

    var CACHE = { DRIVER: null, PDF: null, COMM: null, INACTIVE_DRIVERS: null };

    function runSearchPaged(searchObj) {
        var data = [];
        searchObj.runPaged({ pageSize: 1000 }).pageRanges.forEach(function (r) {
            data = data.concat(searchObj.runPaged().fetch({ index: r.index }).data);
        });
        return data;
    }

    /* ================= INPUT ================= */

    function getInputData() {
        var driverCodes = getDriverSearch().map(function (r) {
            return r.getValue('custrecord_tlg_acs_agent_code');
        });

        var allAgents = getPDFAgents().concat(getCommAgents())
            .filter(function (v, i, a) { return a.indexOf(v) === i; });

        return allAgents.filter(function (c) {
            return driverCodes.indexOf(c) === -1;
        });
    }

    function map(context) {
        context.write(context.key, context.value);
    }

    function reduce(context) {

        var agentCode = context.values[0];
        if (!agentCode) return;

        var results = getTransactions(agentCode);
        var issues = [];

        issues = issues.concat(checkMissingACS(results, agentCode));
        issues = issues.concat(checkInactiveAgents(results, agentCode));
        issues = issues.concat(checkNonVoid(results, agentCode));

        if (issues.length) {
            context.write('RESULT', issues.join(','));
        }
    }

    function summarize(summary) {

        var rows = [];
        summary.output.iterator().each(function (_, v) {
            rows = rows.concat(v.split(','));
            return true;
        });

        rows = rows.concat(getInactiveDrivers());
        if (!rows.length) return;

        var csv = "Record Type,Record ID,Document Number,Vendor,Message\n" +
            rows.map(function (r) { return r.split(':').join(','); }).join('\n');

        var fileObj = file.create({
            name: 'ACS_Driver_Tieout_' + Date.now() + '.csv',
            fileType: file.Type.CSV,
            contents: csv,
            folder: PARAMS.FOLDER
        });

        var fileId = fileObj.save();

        email.send({
            author: config.load({ type: config.Type.COMPANY_PREFERENCES })
                .getValue('custscript_error_email_author'),
            recipients: runtime.getCurrentUser().email,
            subject: 'ACS Tieout Completed',
            body: 'Please find attached ACS Tieout report.',
            attachments: [file.load({ id: fileId })]
        });
    }

    /* ================= SEARCH HELPERS ================= */

    function getTransactions(agentCode) {

        return runSearchPaged(search.create({
            type: 'transaction',
            filters: [
                ['type', 'anyof', 'VendBill', 'VendCred', 'CustCred', 'CustInvc'],
                'AND', ['custcol_agent_ext_id', 'is', agentCode],
                'AND', ['subsidiary', 'anyof', PARAMS.SUB],
                'AND', ['postingperiod', 'anyof', PARAMS.PERIOD],
                'AND', ['amount', 'notequalto', '0.00']
            ],
            columns: [
                'tranid',
                'entity',
                'custcol_tlg_acs_number',
                'custbody_agent_ext_id',
                search.createColumn({ name: 'isinactive', join: 'custcol_tlg_agent_id' })
            ]
        }));
    }

    /* ================= VALIDATIONS ================= */

    function checkMissingACS(results, agentCode) {
        return results.filter(function (r) {
            return !r.getValue('custcol_tlg_acs_number');
        }).map(function (r) {
            return formatRow(r, 'ACS Number Missing', agentCode);
        });
    }

    function checkInactiveAgents(results, agentCode) {
        return results.filter(function (r) {
            return r.getValue({ name: 'isinactive', join: 'custcol_tlg_agent_id' }) === true;
        }).map(function (r) {
            return formatRow(r, 'Inactive Agent', agentCode);
        });
    }

    function checkNonVoid(results, agentCode) {
        return results.map(function (r) {
            return formatRow(r, 'Non Void Transaction', agentCode);
        });
    }

    function formatRow(r, message, agentCode) {

        var vendorName = r.getText('entity') || '';
        var vendorId = r.getValue('entity') || '';

        return r.recordType + ':' +
            r.id + ':' +
            r.getValue('tranid') + ':' +
            vendorName + ' (' + vendorId + ')' + ':' +
            message + ' | Agent Code: ' + agentCode;
    }

    function getInactiveDrivers() {

        if (CACHE.INACTIVE_DRIVERS) return CACHE.INACTIVE_DRIVERS;

        var s = search.load({ id: PARAMS.DRIVER_SEARCH });
        s.filters.push(search.createFilter({
            name: 'isinactive',
            join: 'custrecord_tlg_acs_agent_id',
            operator: 'is',
            values: 'T'
        }));

        CACHE.INACTIVE_DRIVERS = runSearchPaged(s).map(function (r) {
            return 'Driver Record:' +
                r.id + '::' +
                r.getValue('custrecord_tlg_acs_agent_code') +
                ':Inactive Agent | Agent Code: ' +
                r.getValue('custrecord_tlg_acs_agent_code');
        });

        return CACHE.INACTIVE_DRIVERS;
    }

    /* ================= DRIVER / PDF / COMM ================= */

    function getDriverSearch() {
        if (CACHE.DRIVER) return CACHE.DRIVER;
        var s = search.load({ id: PARAMS.DRIVER_SEARCH });
        s.filters.push(
            search.createFilter({ name: 'custrecord_tlg_acs_agent_subsidiary', operator: 'anyof', values: PARAMS.SUB }),
            search.createFilter({ name: 'custrecord_tlg_acs_period', operator: 'anyof', values: PARAMS.PERIOD })
        );
        return CACHE.DRIVER = runSearchPaged(s);
    }

    function getPDFAgents() {
        if (CACHE.PDF) return CACHE.PDF;
        var s = search.load({ id: PARAMS.PDF_SEARCH });
        s.filters.push(
            search.createFilter({ name: 'subsidiary', operator: 'anyof', values: PARAMS.SUB }),
            search.createFilter({ name: 'postingperiod', operator: 'anyof', values: PARAMS.PERIOD })
        );
        return CACHE.PDF = runSearchPaged(s).map(function (r) {
            return r.getValue({ name: 'custcol_agent_ext_id', summary: search.Summary.GROUP });
        });
    }

    function getCommAgents() {
        if (CACHE.COMM) return CACHE.COMM;
        var s = search.load({ id: PARAMS.COMM_SEARCH });
        s.filters.push(
            search.createFilter({ name: 'custrecord_tlg_hotel_comm_subsidiary', operator: 'anyof', values: PARAMS.SUB }),
            search.createFilter({ name: 'custrecord_tlg_hotel_comm_period', operator: 'anyof', values: PARAMS.PERIOD })
        );
        return CACHE.COMM = runSearchPaged(s).map(function (r) {
            return r.getValue({ name: 'custrecord_tlg_hotel_comm_agent_code', summary: search.Summary.GROUP });
        });
    }

    return {
        getInputData: getInputData,
        map: map,
        reduce: reduce,
        summarize: summarize
    };
});
