/**
 * @NApiVersion 2.1
 * @NScriptType MapReduceScript
 */

define(['N/search', 'N/record', 'N/log'], (search, record, log) => {

    const SAVED_SEARCH_ID = 'customsearch1770029147263';
    const getInputData = () => {
        return search.load({
            id: SAVED_SEARCH_ID
        });
    };
    const map = (context) => {
        try {
            const result = JSON.parse(context.value);

            const invoiceId = result.id;

            const lineCount = Number(
                result.values['COUNT(line)']
            );

            if (lineCount > 1) {
                context.write({
                    key: invoiceId,
                    value: lineCount
                });
            }

        } catch (e) {
            log.error('Map Error', e);
        }
    };
    const reduce = (context) => {
        try {
            const invoiceId = context.key;

            record.delete({
                type: record.Type.INVOICE,
                id: invoiceId
            });

            log.audit('Invoice Deleted', {
                invoiceId: invoiceId,
                lineCount: context.values[0]
            });

        } catch (e) {
            log.error(`Delete failed for Invoice ${context.key}`, e);
        }
    };
    const summarize = (summary) => {
        log.audit('Summary', {
            usage: summary.usage,
            concurrency: summary.concurrency,
            yields: summary.yields
        });

        summary.mapSummary.errors.iterator().each((key, error) => {
            log.error('Map Error: ' + key, error);
            return true;
        });

        summary.reduceSummary.errors.iterator().each((key, error) => {
            log.error('Reduce Error: ' + key, error);
            return true;
        });
    };

    return {
        getInputData,
        map,
        reduce,
        summarize
    };
});
