/**
 * @NApiVersion 2.1
 * @NScriptType MapReduceScript
 * @NModuleScope SameAccount
 */
define([
    'N/search','N/record','N/runtime','N/xml','N/file','N/render','N/url','N/encode','N/email','N/format','N/query','N/task','N/log'
], function(search, record, runtime, xmlMod, file, render, url, encode, email, format, query, task, log) {

    var defaultEmpID = 215516;
    var folderID = 148222;
    var templateDefault = 25;
    var brazilTemplate = 26;
    var logoDefault = '3662874';
    var logoBrazil = '3662875';

    var statementScript = runtime.getCurrentScript();
    var FILE_CONST = {
        SEARCH_INPUT: statementScript.getParameter({name:'custscript_weeklyst_searchinput'}),
        SEARCH_TRANSACTIONS: statementScript.getParameter({name:'custscript_weeklyst_searchtransactions'}),
        ARRIVAL_DATE: statementScript.getParameter({name: 'custscript_weeklyst_searcharrivaldate'}) || '',
        RESUME_FROM_CUSTOMER: statementScript.getParameter({name:'custscript_resume_from_customer'}) || ''
    };

    // ------------ getInputData (kept your saved search approach) ------------
	function getInputData() {
		log.audit("begin getInputData", new Date());
		var statementSearch = search.load(FILE_CONST.SEARCH_INPUT);

		var defValue = statementScript.getParameter({ name: 'custscript_customerfilter' });

		if (defValue){ 
			var paramFilter = search.createFilter({
				name: 'internalid',
				join: 'customer',
				operator: 'anyof',
				values: defValue
			});
			log.debug("adding filter");
			statementSearch.filters.push(paramFilter);
		}

        // Optional resume (if MR was rescheduled mid-run)
        if (FILE_CONST.RESUME_FROM_CUSTOMER) {
            var resumeFilter = search.createFilter({
                name: 'internalidnumber',
                join: 'customer',
                operator: 'greaterthan',
                values: FILE_CONST.RESUME_FROM_CUSTOMER
            });
            statementSearch.filters.push(resumeFilter);
        }

		return statementSearch;
	}

    // ------------ reduce ------------
	function reduce(context) {
		log.debug("Reduce Record", JSON.stringify(context));
        var startTime = Date.now();

		for (var i in context.values) {
            // governance / time check (reschedule if running out)
            var remaining = runtime.getCurrentScript().getRemainingUsage();
            var elapsedMs = Date.now() - startTime;
            // If remaining usage low or runtime > 40 minutes, reschedule
            if (remaining < 200 || elapsedMs > (40 * 60 * 1000)) {
                log.audit('Rescheduling MR to avoid timeout', 'remaining=' + remaining + ' elapsedMs=' + elapsedMs);
                try {
                    var cur = runtime.getCurrentScript();
                    var mrTask = task.create({ taskType: task.TaskType.MAP_REDUCE });
                    mrTask.scriptId = cur.id;
                    mrTask.deploymentId = cur.deploymentId;
                    // pass last processed customer so getInputData's resume filter can pick up
                    var partial = JSON.parse(context.values[i]);
                    var tranData = partial.values;
                    var lastCustomer = tranData["GROUP(entity)"].value;
                    mrTask.params = { custscript_resume_from_customer: lastCustomer };
                    mrTask.submit();
                    log.audit('MR rescheduled', 'resume from ' + lastCustomer);
                } catch (rsErr) {
                    log.error('reschedule failed', rsErr);
                }
                return;
            }

			var tranData = JSON.parse(context.values[i]);
			tranData = tranData.values;
			var custId = tranData["GROUP(entity)"].value;
			var typeId = tranData["GROUP(custentity_payment_type.customer)"] ? tranData["GROUP(custentity_payment_type.customer)"].value : '';
			var sumFormula = tranData["SUM(formulacurrency)"];
			var sumAmt = tranData["SUM(amount)"];
			log.debug('Record Data', custId + ' - ' + typeId + ' - ' + sumAmt + ' - ' + sumFormula);

            var statementDate = getStatementDate();

			try {
				var checkDueDate = false;

				var cname = custId;//entity Id
				var netAmount = Number(sumFormula);
				log.audit('customer ID', cname);

                // load customer
				var customerRecord = record.load({
					type: record.Type.CUSTOMER,
					id: cname,
                    isDynamic: false
				});

                // build customer object (address retrieval without selectLine)
                var cusObj = {};
                cusObj.cname = custId;
                cusObj.customerName = customerRecord.getValue('isperson') == true || customerRecord.getValue('isperson') == 'T' ? customerRecord.getValue('altname') : customerRecord.getValue('companyname');
                cusObj.arSpecialist = customerRecord.getValue('custentity_bonotel_ar_specialist');
                cusObj.customerEmail = customerRecord.getValue('custentity_2663_email_address_notif') || '';
                cusObj.customerTemplate = customerRecord.getValue('custentity_custom_email_template');

                // address: safe non-dynamic extraction
                var addrCount = customerRecord.getLineCount({ sublistId: 'addressbook' }) || 0;
                for (var a = 0; a < addrCount; a++) {
                    var defaultBill = customerRecord.getSublistValue({ sublistId: 'addressbook', fieldId: 'defaultbilling', line: a });
                    if (!defaultBill) continue;
                    var addressSubrecord = customerRecord.getSublistSubrecord({ sublistId: 'addressbook', fieldId: 'addressbookaddress', line: a });
                    if (addressSubrecord) {
                        cusObj.customeraddress = addressSubrecord.getValue({ fieldId: 'addr1' }) || ' ';
                        cusObj.city = addressSubrecord.getValue({ fieldId: 'city' }) || ' ';
                        cusObj.state = addressSubrecord.getValue({ fieldId: 'state' }) || ' ';
                        cusObj.zip = addressSubrecord.getValue({ fieldId: 'zip' }) || ' ';
                        cusObj.country = addressSubrecord.getValue({ fieldId: 'country' }) || ' ';
                    }
                    break;
                }

                var attachmentArr = [];

                // --- use SuiteQL / paged fetch to get transactions for each currency ---
                var resultsAmount = getTransactionsSuiteQL(cname, 1);
                netAmount = getBalance(cname, resultsAmount, 1);
                var filesUSD = createPDF(cusObj, netAmount, resultsAmount, statementDate, 1);
                if(!isEmpty(filesUSD)) {
                    attachmentArr.push(filesUSD.pdf);
                    attachmentArr.push(filesUSD.excel);
                }

                var resultsAmountGBP = getTransactionsSuiteQL(cname, 2);
                if(!isEmpty(resultsAmountGBP)) {
                    var netAmountGBP = getBalance(cname, resultsAmountGBP, 2);
                    log.debug('GBP check', resultsAmountGBP.length + ' results | netAmountGBP=' + netAmountGBP);
                    if(netAmountGBP > 0) {
                        var filesGBP = createPDF(cusObj, netAmountGBP, resultsAmountGBP, statementDate, 2);
                        if(!isEmpty(filesGBP)) {
                            attachmentArr.push(filesGBP.pdf);
                            attachmentArr.push(filesGBP.excel);
                        }
                    }
                }

                var resultsAmountEUR = getTransactionsSuiteQL(cname, 4);
                if(!isEmpty(resultsAmountEUR)) {
                    var netAmountEUR = getBalance(cname, resultsAmountEUR, 4);
                    log.debug('EUR check', resultsAmountEUR.length + ' results | netAmountEUR=' + netAmountEUR);
                    if(netAmountEUR > 0) {
                        var filesEUR = createPDF(cusObj, netAmountEUR, resultsAmountEUR, statementDate, 4);
                        if(!isEmpty(filesEUR)) {
                            attachmentArr.push(filesEUR.pdf);
                            attachmentArr.push(filesEUR.excel);
                        }
                    }
                }

                log.debug('REDUCE cname=' + cname, 'Number of files created: ' + attachmentArr.length);

                //only send email if not triggered via suitelet deployment id check
                var curScript = runtime.getCurrentScript();
                var deploymentId = curScript.deploymentId;
                if (deploymentId != 'customdeploy_weekly_statements') {
                    sendEmail(cusObj, statementDate, attachmentArr);
                }

                record.submitFields({
                    type: record.Type.CUSTOMER,
                    id: cname,
                    values: {
                        custentity_upaya_last_statement_date: statementDate
                    }
                });
                log.debug('FINISH custId=' + custId, cname + ' statement date ' + statementDate);

			} catch(e) {
				log.error('Error: ', (e.name || e.getCode || e.code) + ' - ' + (e.message || e.getDetails || e));
			}
		} // end for context.values
	} // end reduce

    // --------------- SuiteQL / paged transactions fetch ----------------
    function getTransactionsSuiteQL(custInternalId, currencyId) {
        // Build SuiteQL selecting fields used in createPDF/getBalance/getTransactions loops
        // NOTE: if your account requires specific join aliases for custom joins (customer account altname or reservation link),
        // those may need small adjustments. This query selects standard & custbody_* fields referenced in your script.
        var binds = { cid: custInternalId, cur: currencyId };
        var sql = ""
            + "SELECT t.id AS internalid, t.tranid AS tranid, t.type AS type, t.amount AS amount, t.fxamount AS fxamount, "
            + "t.amountremaining AS amountremaining, t.fxamountremaining AS fxamountremaining, "
            + "t.custbody_total_earmarks AS custbody_total_earmarks, t.custbody_booking_number AS custbody_booking_number, "
            + "t.custbody_guest_names AS custbody_guest_names, t.custbody_arrival_date AS custbody_arrival_date, "
            + "t.custbody_departure_date AS custbody_departure_date, t.custbody_provider_id AS custbody_provider_id, "
            + "t.custbody_tour_operator_order_number AS custbody_tour_operator_order_number, t.custbody_due_date AS custbody_due_date, "
            + "t.duedate AS duedate "
            + "FROM transaction t "
            + "WHERE t.entity = :cid AND t.currency = :cur "
            + (FILE_CONST.ARRIVAL_DATE ? " AND NVL(t.custbody_arrival_date, DATE '1900-01-01') >= TO_DATE(:adate, 'MM/DD/YYYY') " : "")
            + "ORDER BY t.trandate ASC, t.id ASC";

        if (FILE_CONST.ARRIVAL_DATE) binds.adate = FILE_CONST.ARRIVAL_DATE;

        var out = [];
        try {
            var paged = query.runSuiteQLPaged({ query: sql, params: binds, pageSize: 1000 });
            paged.pageRanges.forEach(function(pr) {
                var page = paged.fetch({ index: pr.index });
                page.data.forEach(function(row) {
                    out.push(row);
                });
                // governance check - break early if needed (caller will handle)
                if (runtime.getCurrentScript().getRemainingUsage() < 200) {
                    log.audit('getTransactionsSuiteQL: low governance, break paging', 'remaining=' + runtime.getCurrentScript().getRemainingUsage());
                    return;
                }
            });
        } catch (e) {
            log.error('getTransactionsSuiteQL error', e);
            throw e; // bubble up so reducer can handle/reschedule
        }
        return out;
    }

    // ------------------ createPDF (kept original logic with minimal adjustments) ------------------
    function createPDF(cusObj, netAmount, resultsAmount, statementDate, currency) {
        if (isEmpty(netAmount) || isEmpty(resultsAmount) || resultsAmount.length === 0) return;
        log.debug('createPDF START', 'netAmount=' + netAmount + ' for currency=' + currency);
        var currencyObj = loadCurrency(currency);
        var currencySymbol = currencyObj.symbol;
        var currencyCode = currencyObj.code;

        var cname = cusObj.cname;
        var customerName = cusObj.customerName;
        var customerTemplate = cusObj.customerTemplate;
        var customeraddress = cusObj.customeraddress;
        var city = cusObj.city;
        var state = cusObj.state;
        var zip = cusObj.zip;
        var country = cusObj.country;

        var today = getTimestamp();

        // build header image + customer info (kept your html)
        var strNamePic = "<table>";
        strNamePic += "<tr><td>";
        strNamePic += "<img  src=\"";
        try {
            if (customerTemplate == brazilTemplate) {
                var img = file.load({id: logoBrazil});
                var imgUrl = img.url;
                var path = xmlMod.escape({ xmlText: imgUrl });
            } else {
                var img = file.load({id: logoDefault});
                var imgUrl = img.url;
                var path = xmlMod.escape({ xmlText: imgUrl });
            }
            strNamePic +=  path;
        } catch (e) {
            log.debug('logo load failed', e);
        }
        strNamePic += "\"></img>";
        strNamePic += "</td></tr>";
        strNamePic += "</table>";

        var strName = "<table>";
        strName += "<tr><td></td><td>Customer:</td><td>"+ xmlMod.escape({xmlText: customerName}) +"</td></tr>";
        strName += "<tr><td></td><td>Address:</td><td>"+ xmlMod.escape({xmlText: customeraddress}) +"</td></tr>";
        strName += "<tr><td></td><td>City:</td><td>"+ xmlMod.escape({xmlText: city}) +"</td></tr>";
        strName += "<tr><td></td><td>State:</td><td>"+ xmlMod.escape({xmlText: state}) +"</td></tr>";
        strName += "<tr><td></td><td>Country:</td><td>"+ xmlMod.escape({xmlText: country}) +"</td></tr>";
        strName += "<tr><td></td><td>ZipCode:</td><td>"+ xmlMod.escape({xmlText: zip}) +"</td></tr>";
        strName += "<tr><td></td><td>Statement Date:</td><td>"+ statementDate +"</td></tr>";
        strName += "<tr><td></td><td>Amount Due:</td><td>"+ currencySymbol + ' ' + netAmount +"</td></tr>";
        strName += "</table>";

        var strName2 = '<table width="100%" border="1" style="border-color: #808080; border-collapse:collapse;">';
        strName2 +='<thead>';
        strName2 +='<tr style="font-weight:bold; height:10px; font-size: 8px; background-color:Gray; color: #FFFFFF;" align="left">';
        strName2 +='<th>Hotel Name</th><th>Account #</th><th>Reservation #</th><th>Your Ref. #</th><th>Arrival</th><th>Departure</th><th>Guest(s) Name</th><th>Due Date</th><th>Reservation Value</th><th>Amount Due</th>';
        strName2 +='</tr></thead>';

        var xmlString = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
        xmlString += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" ';
        xmlString += 'xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
        xmlString += '<Worksheet ss:Name="Sheet1"><Table>';
        xmlString += '<Row><Cell><Data ss:Type="String">Name</Data></Cell><Cell><Data ss:Type="String">'+customerName+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Address</Data></Cell><Cell><Data ss:Type="String">'+customeraddress+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">City</Data></Cell><Cell><Data ss:Type="String">'+city+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">State</Data></Cell><Cell><Data ss:Type="String">'+state+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Country</Data></Cell><Cell><Data ss:Type="String">'+country+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">ZipCode</Data></Cell><Cell><Data ss:Type="String">'+zip+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String"> </Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Statement Date:</Data></Cell><Cell><Data ss:Type="String">'+statementDate+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Amount Due</Data></Cell><Cell><Data ss:Type="String">'+currencySymbol+'  '+netAmount+'</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String"> </Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Hotel Name</Data></Cell><Cell><Data ss:Type="String">Account #</Data></Cell><Cell><Data ss:Type="String">Invoice #</Data></Cell><Cell><Data ss:Type="String">Reservation #</Data></Cell><Cell><Data ss:Type="String">Your Ref. #</Data></Cell><Cell><Data ss:Type="String">Arrival</Data></Cell><Cell><Data ss:Type="String">Departure</Data></Cell><Cell><Data ss:Type="String">Guest(s) Name</Data></Cell><Cell><Data ss:Type="String">Due Date</Data></Cell><Cell><Data ss:Type="String">Reservation Value</Data></Cell><Cell><Data ss:Type="String">Amount Due</Data></Cell></Row>';

        // aging variables
        var agingCurrent =0.00;
        var agingStage1 = 0.00;
        var agingStage2 = 0.00;
        var agingStage3 = 0.00;
        var agingStage4 = 0.00;
        var agingStage5 = 0.00;

        var resultsFinal = resultsAmount;
        log.debug('# of statement lines','resultsFinal=' + (resultsFinal?resultsFinal.length:0));

        // Build rows from SuiteQL QueryResultRow objects
        for (var y = 0; resultsFinal != null && y < resultsFinal.length; y++) {
            var resultsget = resultsFinal[y];
            // getValue by alias names we selected in SQL
            // QueryResultRow.getValue accepts { name: 'alias' }
            var amount = currency != 1 ? formatAmount(resultsget.getValue({ name: 'amount' })) : formatAmount(resultsget.getValue({ name: 'fxamount' }));
            // fallback: get raw values for further calculations
            var rawAmount = currency != 1 ? resultsget.getValue({ name: 'amount' }) : resultsget.getValue({ name: 'fxamount' });
            var booknum = resultsget.getValue({ name: 'custbody_booking_number' }) || '';
            var guest = resultsget.getValue({ name: 'custbody_guest_names' }) || '';
            var arrival = resultsget.getValue({ name: 'custbody_arrival_date' }) || '';
            var departure = resultsget.getValue({ name: 'custbody_departure_date' }) || '';
            var provider = resultsget.getValue({ name: 'custbody_provider_id' }) || '';
            // account/reservation_link: may be populated via saved search join in original code.
            var account = ''; // if you require altname from joined record, we'll adjust SQL later
            var rez = resultsget.getValue({ name: 'custbody_booking_number' }) || '';
            var tranId = resultsget.getValue({ name: 'tranid' }) || '';
            var depositamount = resultsget.getValue({ name: 'custbody_total_earmarks' }) || 0;
            var amountRem = 0.00;
            var type = resultsget.getValue({ name: 'type' }) || '';
            var dueDate = '';

            // amount numeric calculations
            var amtNum = currency != 1 ? parseFloat(resultsget.getValue({ name: 'amount' }) || 0) : parseFloat(resultsget.getValue({ name: 'fxamount' }) || 0);

            if (type === 'SalesOrd') {
                tranId = '';
                dueDate = resultsget.getValue({ name: 'custbody_due_date' }) || '';
                amountRem = getnumber(amtNum) - getnumber(depositamount);
            } else {
                dueDate = resultsget.getValue({ name: 'custbody_due_date' }) || resultsget.getValue({ name: 'duedate' }) || '';
                if (currency != 1) {
                    amountRem = getnumber(resultsget.getValue({ name: 'fxamountremaining' }) || resultsget.getValue({ name: 'fxamountremaining' })) ;
                } else {
                    amountRem = getnumber(resultsget.getValue({ name: 'amountremaining' }) || resultsget.getValue({ name: 'amountremaining' })) ;
                }
            }

            if (amountRem > 0) {
                var agingdays = 0;
                if (dueDate) agingdays = days_between(statementDate, dueDate);
                if (agingdays === 0 || agingdays < 0) { agingCurrent += getnumber(amountRem); }
                else if (agingdays <= 30 && agingdays >= 1) { agingStage1 += getnumber(amountRem); }
                else if (agingdays <= 60 && agingdays >= 31) { agingStage2 += getnumber(amountRem); }
                else if (agingdays <= 90 && agingdays >= 61) { agingStage3 += getnumber(amountRem); }
                else if (agingdays >= 90) { agingStage4 += getnumber(amountRem); }
                agingStage5 += getnumber(amountRem);

                // append to xmlString (Excel) and strName2 (HTML table)
                xmlString += '<Row>' +
                    '<Cell><Data ss:Type="String">' + (provider || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (account || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (tranId || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (booknum || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (resultsget.getValue({ name: 'custbody_tour_operator_order_number' }) || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (arrival || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (departure || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (guest || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (dueDate || '') + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (currencySymbol + '  ' + formatMoney(amount)) + '</Data></Cell>' +
                    '<Cell><Data ss:Type="String">' + (currencySymbol + '  ' + formatMoney(amountRem)) + '</Data></Cell>' +
                    '</Row>';

                strName2 += "<tr>";
                strName2 += '<td>' + xmlMod.escape({ xmlText: provider || '' }) + '</td>';
                strName2 += '<td>' + xmlMod.escape({ xmlText: account || '' }) + '</td>';
                strName2 += '<td>' + xmlMod.escape({ xmlText: booknum || '' }) + '</td>';
                strName2 += '<td>' + xmlMod.escape({ xmlText: (resultsget.getValue({ name: 'custbody_tour_operator_order_number' }) || '') }) + '</td>';
                strName2 += '<td>' + (arrival || '') + '</td>';
                strName2 += '<td>' + (departure || '') + '</td>';
                strName2 += '<td>' + xmlMod.escape({ xmlText: guest || '' }) + '</td>';
                strName2 += '<td>' + (dueDate || '') + '</td>';
                strName2 += '<td style="text-align:right">' + (currencySymbol + '  ' + formatMoney(amount)) + '</td>';
                strName2 += '<td style="text-align:right">' + (currencySymbol + '  ' + formatMoney(amountRem)) + '</td>';
                strName2 += "</tr><tr></tr>";
            }
        } // end for resultsFinal

        // finalize excel xml
        xmlString += '<Row><Cell><Data ss:Type="String"></Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Aging</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">Current</Data></Cell><Cell><Data ss:Type="String">1-30 Days</Data></Cell><Cell><Data ss:Type="String">31-60 Days</Data></Cell><Cell><Data ss:Type="String">61-90 Days</Data></Cell><Cell><Data ss:Type="String">Over 90 Days</Data></Cell><Cell><Data ss:Type="String">Total</Data></Cell></Row>';
        xmlString += '<Row><Cell><Data ss:Type="String">'+currencySymbol+'  '+formatMoney(agingCurrent.toFixed(2))+'</Data></Cell><Cell><Data ss:Type="String">'+currencySymbol+'  '+formatMoney(agingStage1.toFixed(2))+'</Data></Cell><Cell><Data ss:Type="String">'+currencySymbol+'  '+formatMoney(agingStage2.toFixed(2))+'</Data></Cell><Cell><Data ss:Type="String">'+currencySymbol+'  '+formatMoney(agingStage3.toFixed(2))+'</Data></Cell><Cell><Data ss:Type="String">'+currencySymbol+'  '+formatMoney(agingStage4.toFixed(2))+'</Data></Cell><Cell><Data ss:Type="String">'+currencySymbol+'  '+formatMoney(agingStage5.toFixed(2))+'</Data></Cell></Row>';
        xmlString += '</Table></Worksheet></Workbook>';

        // save Excel
        var strXmlEncoded = encode.convert({ string: xmlString, inputEncoding: encode.Encoding.UTF_8, outputEncoding: encode.Encoding.BASE_64 });
        var objXlsFile = file.create({
            name : (currency == 2 ? 'ExcelGBP_' : 'ExcelUSD_') + customerName + '__' + today + '.xls',
            fileType : file.Type.EXCEL,
            contents : strXmlEncoded
        });
        objXlsFile.folder = folderID;
        var fileID = objXlsFile.save();

        // finalize html parts for pdf
        strName2 += '</table>';
        var strNameSpace = '<table><tr><td></td><td></td><td></td></tr></table>';
        var strName3 = '<table width="100%" border="1" style="border-color: #808080; border-collapse:collapse;"><tr style="font-weight:bold; height:10px; font-size: 8px; background-color:Gray; color: #FFFFFF;"><th>Current</th><th>1-30 Days</th><th>31-60 Days</th><th>61-90 Days</th><th>Over 90 Days</th><th>Total</th></tr>';
        strName3 += '<tr><td style="text-align:right">'+currencySymbol+'  '+formatMoney(agingCurrent.toFixed(2))+'</td><td style="text-align:right">'+currencySymbol+'  '+formatMoney(agingStage1.toFixed(2))+'</td><td style="text-align:right">'+currencySymbol+'  '+formatMoney(agingStage2.toFixed(2))+'</td><td style="text-align:right">'+currencySymbol+'  '+formatMoney(agingStage3.toFixed(2))+'</td><td style="text-align:right">'+currencySymbol+'  '+formatMoney(agingStage4.toFixed(2))+'</td><td style="text-align:right">'+currencySymbol+'  '+formatMoney(agingStage5.toFixed(2))+'</td></tr></table>';

        var payLinkURL = getPayLinkURL(cname);
        var strPayLink = '<table width="100%" style="margin-top:30px"><tr style="font-size:12px;color:blue"><td align="right">';
        if(!isEmpty(payLinkURL)) {
            var payLinkPath = xmlMod.escape({ xmlText: payLinkURL });
            strPayLink += '<a href="' + payLinkPath + '">Click Here to Pay</a>';
        }
        strPayLink += '</td></tr></table>';

        var xml = "<?xml version=\"1.0\"?>\n<!DOCTYPE pdf PUBLIC \"-//big.faceless.org//report\" \"report-1.1.dtd\">\n";
        xml += "<pdf>\n<head><macrolist><macro id=\"myheader\"><p align=\"left\">" + strNamePic + "</p></macro><macro id=\"myfooter\"><p align=\"right\">Page <pagenumber/> of <totalpages/></p></macro></macrolist></head>";
        xml += "<body font-size=\"7\" header=\"myheader\" header-height=\"20mm\" footer=\"myfooter\" footer-height=\"20mm\">";
        xml += strName + strName2 + strNameSpace + strName3 + strPayLink;
        xml += "</body></pdf>";

        var file2 = render.xmlToPdf({ xmlString: xml });
        file2.folder = folderID;
        file2.name = 'PDF'+currencyCode+'_'+customerName+'_'+'_'+today+'.pdf';
        var fileID2 = file2.save();

        // attach files
        try {
            record.attach({ record: { type: 'file', id: fileID2 }, to: { type: record.Type.CUSTOMER, id: cname } });
            record.attach({ record: { type: 'file', id: fileID }, to: { type: record.Type.CUSTOMER, id: cname } });
        } catch (e) {
            log.error('Attach files failed', e);
        }

        return { pdf: fileID2, excel: fileID };
    } // end createPDF

    // --------------- sendEmail (kept) ----------------
    function sendEmail(cusObj, statementDate, attachmentArr) {
        var cname = cusObj.cname;
        var customerName = cusObj.customerName;
        var arSpecialist = cusObj.arSpecialist;
        var customerEmail = cusObj.customerEmail || '';
        var customerTemplate = cusObj.customerTemplate;
        log.debug('sendEmail cname=' + cname, 'fileIds: ' + attachmentArr);

        var emailTempId;
        if (customerTemplate == brazilTemplate) {
            emailTempId = brazilTemplate;
        } else {
            if (customerTemplate && customerTemplate.length > 0) emailTempId = parseInt(customerTemplate);
            else emailTempId = templateDefault;
        }

        var emailTemp = record.load({ type: 'emailtemplate', id: emailTempId });
        var emailBody = emailTemp.getValue('content') || ('Please find attached statement for ' + statementDate);

        var custArray = (customerEmail || '').split(';').map(function(s){ return s.trim(); }).filter(Boolean);
        var fileLoadArr = [];
        for (var f = 0; f < attachmentArr.length; f++) {
            try {
                var fileload = file.load({ id: attachmentArr[f] });
                fileLoadArr.push(fileload);
            } catch (e) {
                log.error('file.load failed for ' + attachmentArr[f], e);
            }
        }

        var emailSubject = (customerName || 'Customer') + ' Statements for ' + statementDate;
        try {
            email.send({
                author: defaultEmpID,
                recipients: custArray,
                subject: emailSubject,
                body: emailBody,
                attachments: fileLoadArr,
                relatedRecords: { entityId: cname }
            });
            log.audit('EMAIL SENT cname='+ cname, emailSubject);
        } catch (e) {
            log.error('email.send failed', e);
        }
        return true;
    }

    // ---------------- getBalance (kept, adapted for QueryResultRow) ----------------
    function getBalance(cname, resultsAmount, currency) {
        if (!resultsAmount || resultsAmount.length === 0) return '';
        log.debug('getBalance START', 'cname=' + cname + ' | currency=' + currency + ' | resultsAmount.length=' + resultsAmount.length);

        var clientBalance = 0;
        var dueDate = '';
        var checkDueDate = false;
        for (var aa = 0; resultsAmount != null && aa < resultsAmount.length; aa++) {
            var resultsGetAmount = resultsAmount[aa];

            // for QueryResultRow objects, use getValue({name: 'alias'})
            var _type = resultsGetAmount.getValue({ name: 'type' }) || '';
            var depamt = parseFloat(resultsGetAmount.getValue({ name: 'custbody_total_earmarks' }) || 0);
            var amt = currency == 1 ? parseFloat(resultsGetAmount.getValue({ name: 'amount' }) || 0) : parseFloat(resultsGetAmount.getValue({ name: 'fxamount' }) || 0);

            var remaining = getnumber(amt) - getnumber(depamt);

            if (_type === 'SalesOrd') {
                remaining = getnumber(amt) - getnumber(depamt);
            } else {
                if (currency == 1) remaining = parseFloat(resultsGetAmount.getValue({ name: 'amountremaining' }) || 0);
                else remaining = parseFloat(resultsGetAmount.getValue({ name: 'fxamountremaining' }) || 0);
            }

            // Prepay due date priority
            var custDue = resultsGetAmount.getValue({ name: 'custbody_due_date' });
            var normalDue = resultsGetAmount.getValue({ name: 'duedate' });
            if (!isEmpty(custDue)) dueDate = custDue;
            else dueDate = normalDue;

            if (!dueDate) {
                checkDueDate = true;
                log.audit("setting check due date to true and breaking", resultsGetAmount.getValue({ name: 'internalid' }));
                break;
            }
            if (remaining > 0) clientBalance += remaining;

            // governance guard
            if (runtime.getCurrentScript().getRemainingUsage() < 200) {
                log.audit('getBalance: low governance, breaking', 'remaining=' + runtime.getCurrentScript().getRemainingUsage());
                break;
            }
        }

        log.debug('getBalance check', 'clientBalance=' + clientBalance + ' | checkDueDate=' + checkDueDate);
        if (checkDueDate) return;

        var amid1 = clientBalance.toFixed(2);
        var netAmount = formatAmount(amid1);
        if (netAmount == '0.00') {
            log.debug('getBalance is zero!!!', 'Skip this customer ' + cname);
            return '';
        }
        return netAmount;
    }

    // ---------------- getPayLinkURL (kept) ----------------
    function getPayLinkURL(custId) {
		var payLinkURL = '';
		var salesorderSearchObj = search.create({
			type: 'salesorder',
			filters:
			[
			   ['type','anyof','SalesOrd'],
			   'AND',
			   ['mainline','is','T'],
			   'AND',
			   ['status','anyof','SalesOrd:B'],
			   'AND',
			   ['custbody_mes_invl_end_customer_link','isnotempty',''],
			   'AND',
			   ['customermain.internalidnumber','equalto',custId]
			],
			columns:
			[
			   search.createColumn({ name: 'trandate', sort: search.Sort.ASC, label: 'Date' }),
			   search.createColumn({ name: 'tranid', label: 'Document Number' }),
			   search.createColumn({ name: 'custbody_mes_invl_end_customer_link', label: 'MerchantE InvoiceLink End Customer Link' })
			]
		 });
		 var searchResultCount = salesorderSearchObj.runPaged().count;
         if(searchResultCount > 0) {
            var searchResult = salesorderSearchObj.run().getRange({ start: 0, end: 1 });
            payLinkURL = searchResult[0].getValue({ name: 'custbody_mes_invl_end_customer_link' });
         }
		 return payLinkURL;
	}

    // ---------------- utility helpers ----------------
    function isEmpty(param) { return (param === '' || param === null || param === undefined); }

	function formatAmount(nStr) {
		nStr = (nStr===null || nStr===undefined) ? '0' : String(nStr);
		var x = nStr.split('.');
		var x1 = x[0];
		var x2 = x.length > 1 ? '.' + x[1] : '';
		var rgx = /(\d+)(\d{3})/;
		while (rgx.test(x1)) {
			x1 = x1.replace(rgx, '$1' + ',' + '$2');
		}
		return x1 + x2;
	}

	function formatMoney(number, places, symbol, thousand, decimal) {
		number = number || 0;
		places = !isNaN(places = Math.abs(places)) ? places : 2;
		thousand = thousand || ",";
		decimal = decimal || ".";
		var negative = number < 0 ? "-" : "",
			i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
			j = (j = i.length) > 3 ? j % 3 : 0;
		return  negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
	}

	function LogAudit(text) { try { log.audit(text); } catch(e){} }

	function getnumber(id) { var ret = parseFloat(id); if(isNaN(ret)) ret = 0; return ret; }

	function days_between(date1, date2) {
		var ONE_DAY = 1000 * 60 * 60 * 24;
		var date1_date = (typeof date1 === "string") ? format.parse({ value: date1, type: format.Type.DATE }) : date1;
		var date2_date = (typeof date2 === "string") ? format.parse({ value: date2, type: format.Type.DATE }) : date2;
		var difference_ms = (date1_date.getTime() - date2_date.getTime());
		return Math.round(difference_ms/ONE_DAY);
	}

    function loadCurrency(currencyId) {
        var rec = record.load({type: 'currency', id: currencyId});
        var obj = {};
        obj.symbol = rec.getValue({fieldId: 'displaysymbol'}) || '$';
        obj.code = rec.getValue({fieldId: 'symbol'}) || '';
        return obj;
    }

    function getStatementDate() {
        var now = new Date();
        var year = "" + now.getFullYear();
        var month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
        var day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
        var statementDate=  month+'/'+day+'/'+year;
        return statementDate;
    }

    function getTimestamp() {
        var now = new Date();
        var year = "" + now.getFullYear();
        var month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
        var day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
        var hour = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
        var minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
        var second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
        return year + month + day + hour + minute + second;
    }

    // ------------ summarize ------------
	function summarize(summary) {
		// clear the custscript_customerfilter param on deployment (kept from original)
		try {
			record.submitFields({
				type: 'scriptdeployment',
				id: runtime.getCurrentScript().deploymentId || '6143',
				values: { custscript_customerfilter: '' }
			});
		} catch(e) { log.debug('clear param failed', e); }

		log.debug('Summary ' + new Date(), JSON.stringify(summary));

		// log errors
		try {
			if (summary.inputSummary.error) log.error('Input Error', summary.inputSummary.error);
			summary.mapSummary.errors.iterator().each(function(key, e) { log.error('Map Error ' + key, e); return true; });
			summary.reduceSummary.errors.iterator().each(function(key, e) { log.error('Reduce Error ' + key, e); return true; });
		} catch(err) { log.error('summarize error', err); }
	}

    // export entry points
	return {
		getInputData: getInputData,
		reduce: reduce,
		summarize: summarize
	};
});
