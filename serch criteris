/**
 * @NApiVersion 2.0
 * @NScriptType MapReduceScript
 * @NModuleScope public
 */

define(['N/record'], function (record) {

    function getInputData() {
        log.audit('Map/Reduce START', new Date());

        // üëâ Put transaction internal IDs here
        return [
            66200847,
            66201879,
            66148818
            // add more IDs as needed
        ];
    }

    function map(context) {
        var transactionId = context.value;

        try {
            // ‚ö†Ô∏è Change transaction type if needed
            var txnRec = record.load({
                type: record.Type.CUSTOMER_PAYMENT,
                id: transactionId,
                isDynamic: false
            });

            var lineCount = txnRec.getLineCount({ sublistId: 'apply' });

            for (var i = 0; i < lineCount; i++) {
                var isApplied = txnRec.getSublistValue({
                    sublistId: 'apply',
                    fieldId: 'apply',
                    line: i
                });

                if (isApplied) {
                    txnRec.setSublistValue({
                        sublistId: 'apply',
                        fieldId: 'apply',
                        line: i,
                        value: false
                    });
                }
            }

            txnRec.save({
                enableSourcing: true,
                ignoreMandatoryFields: true
            });

            log.audit('Unapplied Successfully', 'Transaction ID: ' + transactionId);

        } catch (e) {
            log.error('Error processing transaction ' + transactionId, e);
        }
    }

    return {
        getInputData: getInputData,
        map: map
    };
});
