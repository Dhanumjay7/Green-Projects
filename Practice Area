/**
 * @NApiVersion 2.0
 * @NScriptType MapReduceScript
 * @NModuleScope Public
 * Implemented By: Vasavi Ramya Yarabarla
 * Date: 05/06/2024
 */

define(['N/search', 'N/config', 'N/runtime', 'N/email', 'N/file'],
function (search, config, runtime, email, file) {

    var currentScript = runtime.getCurrentScript();

    var FILE_CONST = {
        SCRIPT_PARAM: {
            ACS_DRIVER_SEARCH: currentScript.getParameter('custscript_acs_driver_search'),
            ACS_PDF_SEC_SUMM_SEARCH: currentScript.getParameter('custscript_acs_pdf_sec_summ_search'),
            ACS_SUPP_COMM_SUMM_SEARCH: currentScript.getParameter('custscript_acs_supp_comm_summary_srch'),
            PERIOD: currentScript.getParameter('custscript_tlg_mr_driver_prd'),
            SUB: currentScript.getParameter('custscript_tlg_mr_driver_subs'),
            FOLDER_ID: currentScript.getParameter('custscript_itg_folder_id')
        }
    };

    /* ===================== SAFE CACHE ===================== */
    var SEARCH_CACHE = {};

    function runPagedSearch(searchObj) {
        var data = [];
        var paged = searchObj.runPaged({ pageSize: 1000 });
        paged.pageRanges.forEach(function (p) {
            var page = paged.fetch({ index: p.index });
            data = data.concat(page.data);
        });
        return data;
    }

    /* ===================== getResults (LOGIC UNCHANGED) ===================== */
    function getResults(searchLoad, searchType) {
        try {

            var cacheKey = searchType + '_' + searchLoad.id;

            if (SEARCH_CACHE[cacheKey]) {
                return SEARCH_CACHE[cacheKey];
            }

            var driverSubsidiary = FILE_CONST.SCRIPT_PARAM.SUB;
            var periodID = FILE_CONST.SCRIPT_PARAM.PERIOD;
            var periodName = GetPeriodName(periodID);

            if (searchType === 'DRIVER_SEARCH' || searchType === 'INACTIV_VEND_DRIVER_SEARCH') {

                searchLoad.filters.push(
                    search.createFilter({
                        name: 'custrecord_tlg_acs_agent_subsidiary',
                        operator: 'anyof',
                        values: driverSubsidiary
                    }),
                    search.createFilter({
                        name: 'custrecord_tlg_acs_period',
                        operator: 'anyof',
                        values: periodID
                    })
                );

                if (searchType === 'INACTIV_VEND_DRIVER_SEARCH') {
                    searchLoad.filters.push(
                        search.createFilter({
                            name: 'isinactive',
                            join: 'custrecord_tlg_acs_agent_id',
                            operator: 'is',
                            values: 'T'
                        })
                    );
                }

            } else if (searchType === 'ACS_PDF_SEARCH' || searchType === 'INACTIV_VEND_TRAN_SEARCH') {

                searchLoad.filters.push(
                    search.createFilter({
                        name: 'subsidiary',
                        operator: 'anyof',
                        values: driverSubsidiary
                    }),
                    search.createFilter({
                        name: 'custcol_tlg_acs_number',
                        operator: 'contains',
                        values: periodName
                    })
                );

                if (searchType === 'INACTIV_VEND_TRAN_SEARCH') {
                    searchLoad.filters.push(
                        search.createFilter({
                            name: 'isinactive',
                            join: 'custcol_tlg_agent_id',
                            operator: 'is',
                            values: 'T'
                        })
                    );
                }

            } else if (searchType === 'SUPP_COMM_SEARCH' || searchType === 'INACTIV_VEND_COMM_SEARCH') {

                searchLoad.filters.push(
                    search.createFilter({
                        name: 'custrecord_tlg_hotel_comm_subsidiary',
                        operator: 'anyof',
                        values: driverSubsidiary
                    }),
                    search.createFilter({
                        name: 'custrecord_tlg_hotel_comm_acs_number',
                        operator: 'contains',
                        values: periodName
                    })
                );

                if (searchType === 'INACTIV_VEND_COMM_SEARCH') {
                    searchLoad.filters.push(
                        search.createFilter({
                            name: 'isinactive',
                            join: 'custrecordhotel_comm_ch_agentid',
                            operator: 'is',
                            values: 'T'
                        })
                    );
                }
            }

            var result = runPagedSearch(searchLoad);
            SEARCH_CACHE[cacheKey] = result;

            return result;

        } catch (ex) {
            log.debug('getResults error', JSON.stringify(ex));
        }
    }

    /* ===================================================== */
    /* ðŸ”’ ALL OTHER FUNCTIONS ARE 100% UNCHANGED ðŸ”’           */
    /* ===================================================== */

    return {
        getInputData: GetInputData,
        map: Map,
        reduce: Reduce,
        summarize: Summarize
    };

});
