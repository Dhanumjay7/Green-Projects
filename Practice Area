/**
 * @NApiVersion 2.0
 * @NScriptType MapReduceScript
 * @NModuleScope SameAccount
 */

var defaultEmpID = 215516;
var folderID = 148222;
var templateDefault = 25;
var brazilTemplate = 26;
var logoDefault = '3662874';
var logoBrazil = '3662875';

define(['N/search', 'N/record', 'N/runtime', 'N/xml', 'N/file', 'N/render', 'N/url', 'N/encode', 'N/email', 'N/format', 'N/task'],
function(search, record, runtime, xmlMod, file, render, url, encode, email, format, task) {

    // NOTE: do NOT call runtime.getCurrentScript() at top-level.
    // Use helper getScriptParam inside runtime entry points.

    function getScriptParam(name) {
        try {
            var s = runtime.getCurrentScript();
            return s ? s.getParameter({ name: name }) : null;
        } catch (e) {
            log.debug('getScriptParam error', e);
            return null;
        }
    }

    // lazily obtain FILE_CONST values when needed
    function getFileConst() {
        return {
            SEARCH_INPUT: getScriptParam('custscript_weeklyst_searchinput'),
            SEARCH_TRANSACTIONS: getScriptParam('custscript_weeklyst_searchtransactions'),
            ARRIVAL_DATE: getScriptParam('custscript_weeklyst_searcharrivaldate') || '',
            RESUME_FROM_CUSTOMER: getScriptParam('custscript_resume_from_customer') || ''
        };
    }

    /* --------------------------- GET INPUT --------------------------- */
    function getInputData() {
        var FILE_CONST = getFileConst();
        log.audit("begin getInputData", new Date());
        var statementSearch = search.load({ id: FILE_CONST.SEARCH_INPUT });

        var defValue = getScriptParam('custscript_customerfilter');

        if (defValue) {
            var paramFilter = search.createFilter({
                name: 'internalid',
                join: 'customer',
                operator: 'anyof',
                values: defValue
            });
            statementSearch.filters.push(paramFilter);
        }

        // Optional: resume filter if rescheduled mid-run
        if (FILE_CONST.RESUME_FROM_CUSTOMER) {
            var resumeFilter = search.createFilter({
                name: 'internalidnumber',
                join: 'customer',
                operator: 'greaterthan',
                values: FILE_CONST.RESUME_FROM_CUSTOMER
            });
            statementSearch.filters.push(resumeFilter);
        }

        return statementSearch;
    }

    /* --------------------------- REDUCE --------------------------- */
    function reduce(context) {
        var FILE_CONST = getFileConst(); // if reduce needs parameters later
        var startTime = new Date().getTime();
        var thresholdUsage = 350;
        var thresholdTime = 50 * 60 * 1000; // 50 minutes

        for (var i in context.values) {
            var remaining = runtime.getCurrentScript().getRemainingUsage();
            var elapsed = new Date().getTime() - startTime;

            if (remaining < thresholdUsage || elapsed > thresholdTime) {
                log.audit('Rescheduling triggered', 'Remaining=' + remaining + ', Elapsed(ms)=' + elapsed);
                rescheduleMapReduce(context.key);
                return;
            }

            try {
                var tranData = JSON.parse(context.values[i]).values;
                var custId = tranData["GROUP(entity)"].value;
                var statementDate = getStatementDate();
                log.audit('Processing customer', custId);

                var customerRecord = record.load({ type: 'customer', id: custId });
                var cusObj = buildCustomerObject(customerRecord, custId);

                var attachmentArr = [];
                var currencyList = [1, 2, 4];
                for (var c = 0; c < currencyList.length; c++) {
                    var currency = currencyList[c];
                    var resultsAmount = getTransactions(custId, currency);
                    if (!resultsAmount || !resultsAmount.length) continue;

                    var netAmount = getBalance(custId, resultsAmount, currency);
                    if (!netAmount || parseFloat(netAmount) <= 0) continue;

                    var files = createPDF(cusObj, netAmount, resultsAmount, statementDate, currency);
                    if (files) {
                        attachmentArr.push(files.pdf);
                        attachmentArr.push(files.excel);
                    }
                }

                if (attachmentArr.length) {
                    sendEmail(cusObj, statementDate, attachmentArr);
                    record.submitFields({
                        type: 'customer',
                        id: custId,
                        values: { custentity_upaya_last_statement_date: statementDate }
                    });
                }

                log.audit('Customer done', custId);
            } catch (e) {
                log.error('Reduce Error', e);
            }
        }
    }

    /* --------------------------- SUMMARIZE --------------------------- */
    function summarize(summary) {
        log.audit('Summary complete', JSON.stringify(summary));
        if (summary.inputSummary.error)
            log.error('Input Error', summary.inputSummary.error);

        summary.reduceSummary.errors.iterator().each(function (key, error) {
            log.error('Reduce Error for ' + key, error);
            return true;
        });
    }

    /* --------------------------- RESCHEDULE --------------------------- */
    function rescheduleMapReduce(lastCustomerId) {
        try {
            var curScript = runtime.getCurrentScript();
            var mrTask = task.create({ taskType: task.TaskType.MAP_REDUCE });
            mrTask.scriptId = curScript.id;
            mrTask.deploymentId = curScript.deploymentId;
            mrTask.params = { custscript_resume_from_customer: lastCustomerId || '' };
            var taskId = mrTask.submit();
            log.audit('Rescheduled MR', 'taskId=' + taskId + ' from customer=' + lastCustomerId);
        } catch (e) {
            log.error('Reschedule failed', e);
        }
    }

    /* --------------------------- CUSTOMER BUILD --------------------------- */
    function buildCustomerObject(customerRecord, custId) {
        var obj = {};
        obj.cname = custId;
        obj.customerName = customerRecord.getValue('isperson')
            ? customerRecord.getValue('altname')
            : customerRecord.getValue('companyname');
        obj.arSpecialist = customerRecord.getValue('custentity_bonotel_ar_specialist');
        obj.customerEmail = customerRecord.getValue('custentity_2663_email_address_notif');
        obj.customerTemplate = customerRecord.getValue('custentity_custom_email_template');

        var addrCount = customerRecord.getLineCount({ sublistId: 'addressbook' });
        for (var a = 0; a < addrCount; a++) {
            var isDefaultBilling = customerRecord.getSublistValue({
                sublistId: 'addressbook',
                fieldId: 'defaultbilling',
                line: a
            });

            if (isDefaultBilling) {
                var addressSubrecord = customerRecord.getSublistSubrecord({
                    sublistId: 'addressbook',
                    fieldId: 'addressbookaddress',
                    line: a
                });

                if (addressSubrecord) {
                    obj.customeraddress = addressSubrecord.getValue({ fieldId: 'addr1' }) || '';
                    obj.city = addressSubrecord.getValue({ fieldId: 'city' }) || '';
                    obj.state = addressSubrecord.getValue({ fieldId: 'state' }) || '';
                    obj.zip = addressSubrecord.getValue({ fieldId: 'zip' }) || '';
                    obj.country = addressSubrecord.getValue({ fieldId: 'country' }) || '';
                }
                break;
            }
        }

        return obj;
    }

    // ---------- paste all your original helper functions here: createPDF, sendEmail,
    // getBalance, getTransactions, runSearch/runSearchPaged (unchanged) and utilities
    // Make sure none of those call runtime.getCurrentScript() at file-scope.
    // I will not paste the entire original large body here for brevity,
    // but simply ensure those functions remain below and unchanged in logic.

    /* --- utilities copied from your original script --- */
    function getnumber(id) {
        var ret = parseFloat(id);
        if (isNaN(ret)) { ret = 0; }
        return ret;
    }

    function isEmpty(param) {
        return (param == '' || param == null || param == undefined);
    }

    function formatAmount(nStr) {
        nStr += '';
        var x = nStr.split('.');
        var x1 = x[0];
        var x2 = x.length > 1 ? '.' + x[1] : '';
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
        }
        return x1 + x2;
    }

    function formatMoney(number, places, symbol, thousand, decimal) {
        number = number || 0;
        places = !isNaN(places = Math.abs(places)) ? places : 2;
        thousand = thousand || ",";
        decimal = decimal || ".";
        var negative = number < 0 ? "-" : "",
            i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
            j = (j = i.length) > 3 ? j % 3 : 0;
        return negative + (j ? i.substr(0, j) + thousand : "") +
            i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) +
            (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
    }

    function days_between(date1, date2) {
        var ONE_DAY = 1000 * 60 * 60 * 24;
        var date1_date = (typeof date1 == "string")
            ? format.parse({ value: date1, type: format.Type.DATE })
            : date1;
        var date2_date = (typeof date2 == "string")
            ? format.parse({ value: date2, type: format.Type.DATE })
            : date2;
        var date1_ms = date1_date.getTime();
        var date2_ms = date2_date.getTime();
        var difference_ms = (date1_ms - date2_ms);
        return Math.round(difference_ms / ONE_DAY);
    }

    function getStatementDate() {
        var now = new Date();
        var year = "" + now.getFullYear();
        var month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
        var day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
        var statementDate = month + '/' + day + '/' + year;
        return statementDate;
    }

    function getTimestamp() {
        var now = new Date();
        var year = "" + now.getFullYear();
        var month = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
        var day = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
        var hour = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
        var minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
        var second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
        return year + month + day + hour + minute + second;
    }

    return {
        getInputData: getInputData,
        reduce: reduce,
        summarize: summarize
    };
});
